## Запуск проекта

### Полноценный запуск через `docker-compose`:

- Для этого используется файл `docker-compose.yml` и команда `docker-compose up -d`. Важно: обязательно создайте `.env`
  файл, по шаблону `env_example`

### Полу-ручной запуск с помощью `docker-compose-mongo-redis.yml`

- Для этого по умолчанию создаем `venv` окружение python и устанавливаем все зависимости из `requirements.txt`
- Создаем `.env` файл по шаблону `env_example`. Важно: переменные mongo и celery будут работать через localhost
- После запускаем `docker-compose-mongo-redis.yml` с помощью
  команды `docker-compose -f docker-compose-mongo-redis.yml up -d`
- Дальше запускаем flask и celery:
    - flask - `flask --app main run`
    - celery - `celery -A main.celery_app worker -l info`

## Структура проекта

- `celery_app` - содержит функцию по инициализации celery, а так же его таски
- `mongo` - содержит клиент для работы с mongodb, а так же модель, для сохранения картинки в базу данных
- `temp` - *(Перед первым запуском папка не существует)*. Хранит в себе временный результат работы приложения, а именно:
    - Картинки загруженные с клиента. После `upscaler` исходная картинка удаляется
    - Результат работы `upscaler`. После помещения в бд, результат тоже удаляется
      `test` - Содержит тесты, а так же дополнительные файлы для тестов. Существуют следующие виды тестов:
    - `test_not_found_task` - тест, на проверку ответа от сервера на несуществующий id задачи
    - `test_task_without_file` - тест, на проверку ответа от сервера, на задачу без самого файла
    - `test_task_with_bad_file` - тест, на проверку ответа от сервера, на неправильный формат файла
    - `test_with_new_file` - тест, на проверку ответа от сервера, на upscale нового файла, не существующего в бд. В
      тесте идет ожидания статуса SUCCESS or FAILURE. Таймаут на тесты можно задать в
      переменной `TEST_DEFAULT_TIMEOUT_WAITING`. По умолчанию 60 сек
    - `test_with_file_in_db` - тест, на проверку ответа от сервера, на upscale файла существующего в бд
- `upscaler` - содержит модель, а так же функцию для upscale изображения
- `utils` - содержит различные утилиты, а так же константы для приложения
- `views` - вьюшки, для flask
- файл `env_example` - пример заполнения файла .env

## Принцип работы:

1. Пользователь отправляет `POST` запросом картинку на роут `http://host/upscale`. Важно картинка должна в поле с
   ключом `image`. Дополнительно так же картинка должна быть формата `.png` или `.jpg, .jpeg`. Сервер проверяет на
   соответствие формату. Так же сервер проверяет на имя файла, если файл с таким именем в процессе обработки, то сервер
   говорит ожидать клиенту, если же картинка с таким именем есть в бд, то сервер выдает роут на ее получение
2. Если был успешен 1-ый шаг, то картинка временно сохраняется в `temp`. А после в дело вступает `upscale_file` из
   celery
3. `upscale_file` берет картинку из папки temp и улучшает ее. Результат временно попадает в папку temp, после удаляется
   исходный файл. Дальше считывается результат, и байты записываются в mongodb. После результирующий файл тоже
   удаляется.
4. Во время работы `upscale_file` клиент получает id задачи и может отслеживать результат ее выполнения по
   роуту `http://host/tasks/<task_id>`
5. Когда картинка успешно преобразована, клиент может получить ее по роуту `http://host/processed/<file_name>`